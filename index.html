<html>


<script>
    var count = 0;
    var fisrt_conn = true;
    var txtMessage = '';
    var randomLinkUcode = '';

    try {
        //document.getElementById("demo").innerHTML = '12111';

        // var conn = new WebSocket('ws://122.61.173.180');
        console.log('try connect ws://192.168.99.100:8080/Socket');
        var conn = new WebSocket('ws://192.168.99.100:8080/Socket');
        //document.getElementById("demo").innerHTML = '2222';
    }
    catch (err) {
        //document.getElementById("demo").innerHTML = err.message;
    }


    conn.onopen = function (e) {
        console.log("Connection established!");
        if (fisrt_conn) {
            document.getElementById("demo").innerHTML = 'yeah!!';
        }
        let sendData = { 
            command: 'AUTH',
            send_to: 'ALL', 
            device_type: 'MOBILE_GPS', 
            device_code: '100006',
            random_link_ucode: '8753f3ac-3b23-11e8-ab28-0242ac150002',
            message: '' 
        }
        conn.send(JSON.stringify(sendData));
    };

    conn.onmessage = function (e) {
        console.log(e.data);
        txtMessage = e.data + '<br>' + txtMessage;
        document.getElementById("demo").innerHTML = txtMessage;
        let response = JSON.parse(e.data);
        if(response.command == 'AUTH') {
            response.message == 'OK';
            if(response.hasOwnProperty('data'))
                randomLinkUcode = response.data.random_link_ucode;
            ready();
        }
    };

    conn.onerror = function (event) {
        console.log(event.message);
    };

    function sentText() {
        conn.send(document.getElementById("Txt").value);
    }

    function ready() {
      window.setInterval(() => {
        sendMessage();
      }, 1000)
    }
    function sendMessage() {
        console.log('sendMessage');
        count++;
        let position = { position: {latitude: -43.4 - count/1000, longitude: 172.5 + count/50000} }
        let obj = { command: 'MESSAGE', send_to: '', device_type: 'MOBILE_GPS', device_code: '100006', random_link_code: randomLinkUcode, message: position };

        conn.send(JSON.stringify(obj));
    }

</script>

<input type="text" id="Txt">

<button onclick="sentText()"> sent xxxxxxxxxxxx</button>

<div id="mylog"></div>
<div id="demo"></div>

</html>